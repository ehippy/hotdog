<!doctype html>
<html lang="en">
<head>
    <title>Hot Dog Cloud!</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css"
          integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
</head>
<body>


<div class="container">
    <div class="row align-items-center">
        <div class="col-sm">
            <h1>Hotdog Cloud</h1>
        </div>
        <div class="col-sm small text-right">
            <a href="https://docs.google.com/presentation/d/1dD4L0T2ms08jJcvriuyi0J6vaKQjI-1E6JLXYoLvtgM/edit?usp=sharing"
               target="_blank">Presentation</a><br/>
            <a href="https://github.com/ehippy/hotdog" target="_blank">GitHub Project</a>
        </div>
    </div>

</div>

<div class="container">
    <input type="button" class="btn btn-primary btn-lg btn-block"
           onclick="document.getElementById('img_capture').click()" value="Take Photo!">
    <input type="file" accept="image/*" id="img_capture" capture="camera" style="display: none;">
</div>

<div class="container mt-2">
    <div id="list" class="card-deck"></div>
</div>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js"
        integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js"
        integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ"
        crossorigin="anonymous"></script>

<script type="text/javascript">
    var filePicker = document.getElementById('img_capture');

    var drop = document.getElementById('drop');
    var list = document.getElementById('list');
    var apiBaseURL = "https://hotdog.cloud";

    function handleNewFile(e) {
        var files = e.srcElement.files;
        for (var i = 0; i < files.length; i++) {
            var file = files[i];
            var reader = new FileReader();
            reader.addEventListener('loadend', function (e) {
                fetch(apiBaseURL + "/requestUploadURL", {
                    method: "POST",
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: file.name,
                        type: file.type
                    })
                })
                    .then(function (response) {
                        return response.json();
                    })
                    .then(function (json) {
                        return fetch(json.uploadURL, {
                            method: "PUT",
                            body: new Blob([reader.result], {type: file.type})
                        })
                    })
                    .then(function () {


                        var uploadedFileNode = document.createElement('div');
                        uploadedFileNode.className = 'card';
                        uploadedFileNode.innerHTML = '<img class="card-img-top" src="//s3.amazonaws.com/secrethotdogbucket/' + file.name + '">';
                        list.insertBefore(uploadedFileNode, list.firstChild);


                        fetch(apiBaseURL + "/detect", {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                name: file.name
                            })
                        })
                            .then(function (response) {
                                console.log(response);
                                return response.json();
                            })
                            .then(function (json) {

                                var hotDogAnalysis = document.createElement('div');
                                hotDogAnalysis.className = 'card-body';
                                hotDogAnalysis.innerHTML = "<p class=\"card-text\">"
                                    + json.Labels.map((label) => {
                                        return label.Name + '(' + Math.round(label.Confidence) + '%)'
                                    }).join(', ')
                                    + "</p>";
                                uploadedFileNode.appendChild(hotDogAnalysis);
                            });
                    });
            });
            reader.readAsArrayBuffer(file);
        }
        return false;
    }

    filePicker.addEventListener('change', handleNewFile);

</script>


</body>
</html>